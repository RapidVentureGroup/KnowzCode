{
  "name": "validate-installation",
  "version": "1.0.0",
  "description": "Validates that KnowzCode installation completed successfully and hooks are properly configured",

  "parameters": [],

  "actions": [
    {
      "type": "python",
      "code": "from pathlib import Path\nimport json\n\ntarget_dir = Path('.claude')\nerrors = []\nwarnings = []\n\n# Check directory exists\nif not target_dir.exists():\n    errors.append('.claude/ directory not found')\n    outputs['valid'] = False\n    outputs['errors'] = errors\n    outputs['warnings'] = warnings\n    outputs['hooks_working'] = False\n    outputs['commands_count'] = 0\n    outputs['skills_count'] = 0\n    outputs['subagents_count'] = 0\n    outputs['hooks_count'] = 0\n    exit()\n\n# Check subdirectories\nrequired_dirs = [\n    'commands',\n    'skills',\n    'subagents',\n    'hooks/pre-command',\n    'hooks/post-command'\n]\n\nfor subdir in required_dirs:\n    if not (target_dir / subdir).exists():\n        errors.append(f'Missing directory: .claude/{subdir}')\n\n# Check settings.json\nsettings_path = target_dir / 'settings.json'\nif not settings_path.exists():\n    errors.append('settings.json not found - hooks will not work!')\n    hooks_working = False\nelse:\n    try:\n        with open(settings_path, 'r') as f:\n            settings = json.load(f)\n\n        # Validate hooks configuration\n        if 'hooks' not in settings:\n            errors.append('settings.json missing hooks configuration')\n            hooks_working = False\n        else:\n            hooks_config = settings['hooks']\n\n            # Check pre-command hooks\n            if 'pre-command' in hooks_config:\n                pre_commands = hooks_config['pre-command']\n\n                # Check kc-step has required hooks\n                if 'kc-step' in pre_commands:\n                    expected_hooks = ['validate-environment', 'confirm-change-set', 'validate-specs']\n                    actual_hooks = pre_commands['kc-step']\n                    missing = [h for h in expected_hooks if h not in actual_hooks]\n                    if missing:\n                        warnings.append(f'kc-step missing pre-hooks: {\", \".join(missing)}')\n                else:\n                    warnings.append('kc-step not configured with pre-command hooks')\n\n            # Check post-command hooks\n            if 'post-command' in hooks_config:\n                post_commands = hooks_config['post-command']\n                if 'kc-step' not in post_commands:\n                    warnings.append('kc-step not configured with post-command hooks')\n\n            hooks_working = len(errors) == 0\n\n    except Exception as e:\n        errors.append(f'Error reading settings.json: {str(e)}')\n        hooks_working = False\n\n# Count components\ncommands_count = len(list((target_dir / 'commands').glob('*.yaml')))\nskills_count = len(list((target_dir / 'skills').glob('*.json')))\nsubagents_count = len(list((target_dir / 'subagents').glob('*.yaml')))\npre_hooks = len(list((target_dir / 'hooks' / 'pre-command').glob('*.js')))\npost_hooks = len(list((target_dir / 'hooks' / 'post-command').glob('*.js')))\nhooks_count = pre_hooks + post_hooks\n\n# Expected counts from template (approximate - may vary)\nexpected = {\n    'commands': 6,   # kc, kc-step, kc-audit, kc-plan, kc-microfix, kc-install\n    'skills': 17,    # Original 14 + 3 new installation skills\n    'subagents': 15, # Original 14 + installation-orchestrator\n    'hooks': 5       # 3 pre-command + 2 post-command\n}\n\n# Validate component counts (warnings, not errors)\nif commands_count < expected['commands']:\n    warnings.append(f'Expected at least {expected[\"commands\"]} commands, found {commands_count}')\nif skills_count < expected['skills']:\n    warnings.append(f'Expected at least {expected[\"skills\"]} skills, found {skills_count}')\nif subagents_count < expected['subagents']:\n    warnings.append(f'Expected at least {expected[\"subagents\"]} subagents, found {subagents_count}')\nif hooks_count < expected['hooks']:\n    warnings.append(f'Expected {expected[\"hooks\"]} hooks, found {hooks_count}')\n\n# Check that critical hooks exist as files\ncritical_hooks = [\n    'hooks/pre-command/validate-environment.js',\n    'hooks/pre-command/confirm-change-set.js',\n    'hooks/pre-command/validate-specs.js',\n    'hooks/post-command/update-caches.js',\n    'hooks/post-command/git-status.js'\n]\n\nfor hook_path in critical_hooks:\n    if not (target_dir / hook_path).exists():\n        errors.append(f'Critical hook file missing: {hook_path}')\n\noutputs['valid'] = len(errors) == 0\noutputs['errors'] = errors\noutputs['warnings'] = warnings\noutputs['hooks_working'] = hooks_working\noutputs['commands_count'] = commands_count\noutputs['skills_count'] = skills_count\noutputs['subagents_count'] = subagents_count\noutputs['hooks_count'] = hooks_count"
    }
  ]
}
